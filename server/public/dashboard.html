<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatAI Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e27;
            background-image: 
                linear-gradient(rgba(100, 100, 100, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(100, 100, 100, 0.15) 1px, transparent 1px);
            background-size: 50px 50px;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 212, 255, 0.15);
            border-radius: 10px;
            border: 2px solid rgba(0, 212, 255, 0.5);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }
        .header h1 {
            color: #00d4ff;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 0 60px rgba(0, 212, 255, 0.4);
            font-size: 2.5em;
            margin-bottom: 5px;
            font-weight: 700;
        }
        .header p { color: rgba(224, 224, 224, 0.7); font-size: 1.1em; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 24px;
            background: rgba(0, 212, 255, 0.15);
            border: 2px solid rgba(0, 212, 255, 0.5);
            border-radius: 8px;
            cursor: pointer;
            color: #00d4ff;
            font-weight: 600;
            transition: all 0.3s;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        .tab:hover {
            background: rgba(0, 212, 255, 0.25);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
            transform: translateY(-2px);
        }
        .tab.active {
            background: rgba(0, 212, 255, 0.35);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.8);
            border-color: #00d4ff;
        }
        .tab-content {
            display: none;
            background: rgba(26, 31, 58, 0.6);
            border: 2px solid rgba(0, 212, 255, 0.5);
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }
        .tab-content.active { 
            display: block !important; 
        }
        .section { margin-bottom: 30px; }
        .section h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.7), 0 0 30px rgba(0, 212, 255, 0.3);
            font-size: 1.5em;
            font-weight: 700;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #00d4ff;
            font-weight: 600;
        }
        .form-group textarea,
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(10, 14, 39, 0.7);
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        .form-group textarea:focus,
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.7);
            background: rgba(10, 14, 39, 0.8);
        }
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #00d4ff 0%, #00a8cc 100%);
            border: 2px solid rgba(0, 212, 255, 0.8);
            border-radius: 6px;
            color: #0a0e27;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            margin-right: 10px;
            margin-top: 10px;
            text-shadow: 0 0 5px rgba(10, 14, 39, 0.5);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
        }
        .btn:hover {
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.8);
            transform: translateY(-2px);
            background: linear-gradient(135deg, #00e5ff 0%, #00b8dc 100%);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            color: #e0e0e0;
        }
        .conversation-item,
        .rule-item,
        .user-item,
        .message-item {
            background: rgba(26, 31, 58, 0.5);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .conversation-item h3,
        .rule-item h3 {
            color: #00d4ff;
            margin-bottom: 10px;
        }
        .conversation-item p,
        .rule-item p {
            color: rgba(224, 224, 224, 0.8);
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .search-box { margin-bottom: 20px; }
        .search-box input {
            width: 100%;
            padding: 12px;
            background: rgba(10, 14, 39, 0.7);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
        }
        .chat-container {
            background: rgba(26, 31, 58, 0.5);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .chat-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid #00d4ff;
        }
        .chat-message.user {
            background: rgba(0, 255, 100, 0.1);
            border-left-color: #00ff64;
        }
        .chat-input-group {
            display: flex;
            gap: 10px;
        }
        .chat-input-group input {
            flex: 1;
            padding: 12px;
            background: rgba(10, 14, 39, 0.7);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 6px;
            color: #e0e0e0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(26, 31, 58, 0.5);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .stat-card h3 {
            color: #00d4ff;
            font-size: 2em;
            margin-bottom: 10px;
        }
        .stat-card p { color: rgba(224, 224, 224, 0.7); }
        .platform-list { list-style: none; }
        .platform-list li {
            padding: 10px;
            background: rgba(26, 31, 58, 0.4);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            border: 2px solid rgba(0, 212, 255, 0.6);
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.4);
        }
        .modal-content h2 {
            color: #00d4ff;
            margin-bottom: 20px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .rule-list {
            list-style: none;
        }
        .rule-list li {
            padding: 10px;
            background: rgba(26, 31, 58, 0.4);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rule-list li button {
            margin: 0;
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NEURAL CONTROL CENTER</h1>
            <p>AI CONFIGURATION & MANAGEMENT SYSTEM</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('rules')">REGELN</div>
            <div class="tab" onclick="showTab('training')">TRAINING DATA</div>
            <div class="tab" onclick="showTab('test-chat')">TEST CHAT</div>
            <div class="tab" onclick="showTab('statistics')">STATISTIKEN</div>
            <div class="tab" onclick="showTab('users')">USER MANAGEMENT</div>
            <div class="tab" onclick="showTab('settings')">EINSTELLUNGEN</div>
        </div>

        <!-- REGELN TAB -->
        <div id="rules" class="tab-content active">
            <div class="section">
                <h2>Verbotene W√∂rter/Phrasen</h2>
                <div class="form-group">
                    <label>Verbotene W√∂rter (eine pro Zeile)</label>
                    <textarea id="forbiddenWords" placeholder="z.B.&#10;Bot&#10;KI&#10;Fake"></textarea>
                </div>
                <button class="btn" onclick="updateRules()">Speichern</button>
            </div>

            <div class="section">
                <h2>Situations-spezifische Antworten</h2>
                <div id="situationalResponsesList"></div>
                <button class="btn" onclick="showAddSituationModal()">‚ûï Neue Situation hinzuf√ºgen</button>
            </div>

            <div class="section">
                <h2>Bevorzugte W√∂rter</h2>
                <div class="form-group">
                    <label>Bevorzugte W√∂rter (eine pro Zeile)</label>
                    <textarea id="preferredWords" placeholder="z.B.&#10;Hey&#10;Hallo"></textarea>
                </div>
                <button class="btn" onclick="updateRules()">Speichern</button>
            </div>

            <div class="section">
                <h2>Allgemeine Regeln</h2>
                <div class="form-group">
                    <label>Allgemeine Regeln</label>
                    <textarea id="generalRules" placeholder="z.B. Sei immer freundlich und nat√ºrlich"></textarea>
                </div>
                <button class="btn" onclick="updateRules()">Speichern</button>
            </div>
        </div>

        <!-- TRAINING DATA TAB -->
        <div id="training" class="tab-content" style="display: none;">
            <div class="section">
                <h2>‚ñ∫ Neues Gespr√§ch hinzuf√ºgen</h2>
                <form id="addConversationForm">
                    <div class="form-group">
                        <label for="customerMessage">Kunden-Nachricht</label>
                        <textarea id="customerMessage" placeholder="Was hat der Kunde geschrieben?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="moderatorResponse">Moderator/Fake Antwort</label>
                        <textarea id="moderatorResponse" placeholder="Wie hat der Moderator geantwortet?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="situation">Situation</label>
                        <select id="situation">
                            <option value="allgemein">Allgemein</option>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="showAddSituationModal()" style="margin-top: 10px;">‚ûï Neue Situation</button>
                        <p style="margin-top: 10px; color: rgba(224, 224, 224, 0.7); font-size: 0.9em;">
                            W√§hle eine Situation oder erstelle eine neue. Situationen werden aus den "Situations-spezifischen Antworten" geladen.
                        </p>
                    </div>
                    <button type="submit" class="btn">‚ûï Gespr√§ch hinzuf√ºgen</button>
                </form>
            </div>

            <div class="section">
                <h2>Gespeicherte Gespr√§che (<span id="conversationCount">0</span>)</h2>
                <div class="search-box">
                    <input type="text" id="searchConversations" placeholder="Suche" onkeyup="filterConversations()">
                </div>
                <div id="conversationsList"></div>
            </div>
        </div>

        <!-- TEST CHAT TAB -->
        <div id="test-chat" class="tab-content">
            <div class="section">
                <h2>Test Chat</h2>
                <p style="margin-bottom: 20px; color: rgba(224, 224, 224, 0.8);">
                    Teste hier, wie die KI auf verschiedene Nachrichten reagiert. Dies simuliert eine echte Konversation.
                </p>
                <div class="chat-container" id="testChatContainer"></div>
                <div class="chat-input-group">
                    <input type="text" id="testChatInput" placeholder="Schreibe eine Nachricht..." onkeypress="if(event.key==='Enter') sendTestMessage()">
                    <button class="btn" onclick="sendTestMessage()">Senden</button>
                    <button class="btn btn-secondary" onclick="clearTestChat()">Chat leeren</button>
                </div>
            </div>
        </div>

        <!-- STATISTIKEN TAB -->
        <div id="statistics" class="tab-content">
            <div class="section">
                <h2>Nachrichten-Statistiken</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="statToday">0</h3>
                        <p>Heute</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statYesterday">0</h3>
                        <p>Gestern</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statThisWeek">0</h3>
                        <p>Diese Woche</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statTotal">0</h3>
                        <p>Gesamt</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Aktive Plattformen</h2>
                <ul class="platform-list" id="platformList"></ul>
            </div>

            <div class="section">
                <h2>Letzte Nachrichten</h2>
                <div id="recentMessages"></div>
            </div>
        </div>

        <!-- USER MANAGEMENT TAB -->
        <div id="users" class="tab-content">
            <div class="section">
                <h2>Benutzer verwalten</h2>
                <div id="usersList"></div>
                <button class="btn" onclick="showAddUserModal()">‚ûï Neuen Benutzer hinzuf√ºgen</button>
            </div>
        </div>

        <!-- EINSTELLUNGEN TAB -->
        <div id="settings" class="tab-content">
            <div class="section">
                <h2>üìä Google Sheets Integration</h2>
                <p style="margin-bottom: 20px; color: rgba(224, 224, 224, 0.8);">
                    Optional: Speichere alle generierten Nachrichten zus√§tzlich in einem Google Sheet.
                    Dies ist n√ºtzlich f√ºr detaillierte Analysen und Backups.
                </p>
                <p style="margin-bottom: 10px; color: #00d4ff; font-weight: 600;">Methode 1: Google Apps Script Webhook (empfohlen)</p>
                <p style="margin-bottom: 20px; color: rgba(224, 224, 224, 0.8);">
                    Dies ist die einfachste Methode. Du erstellst ein Google Sheet, f√ºgst einen kleinen Code in Google Apps Script ein und ver√∂ffentlichst es als Web-App. Die URL der Web-App tr√§gst du dann hier ein.
                </p>
                <h3 style="color: #00d4ff; margin-top: 20px; text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);">Schritt-f√ºr-Schritt Anleitung:</h3>
                <ol style="color: #e0e0e0; list-style-type: decimal; margin-left: 20px;">
                    <li style="margin-bottom: 10px;">
                        <strong>1. Google Sheet erstellen:</strong> Erstelle ein neues Google Sheet (z.B. "ChatAI Nachrichten Log").
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>2. Google Apps Script √∂ffnen:</strong> Gehe in deinem Google Sheet zu "Erweiterungen" &rarr; "Apps Script". Es √∂ffnet sich ein neuer Tab.
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>3. Code einf√ºgen:</strong> Kopiere den folgenden Code in den Apps Script Editor (ersetze den bestehenden Code in <code>Code.gs</code>):
                        <pre style="background: rgba(0, 0, 0, 0.5); padding: 15px; border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3); color: #00d4ff; overflow-x: auto; font-family: monospace; font-size: 0.9em; margin-top: 10px;"><code>function doPost(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const data = JSON.parse(e.postData.contents);
  
  // Header beim ersten Mal
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(['Datum/Zeit', 'Plattform', 'Chat ID', 'ASA', 'Kunden-Nachricht', 'KI-Antwort']);
  }
  
  // Daten hinzuf√ºgen
  sheet.appendRow([
    data.timestamp,
    data.platform,
    data.chatId,
    data.isASA,
    data.customerMessage,
    data.aiResponse
  ]);
  
  return ContentService.createTextOutput('OK');
}</code></pre>
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>4. Speichern:</strong> Klicke oben links auf das Diskettensymbol "Speichern" (oder Strg+S). Gib dem Projekt einen Namen (z.B. "ChatAI Integration").
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>5. Web-App bereitstellen:</strong> Klicke oben rechts auf "Bereitstellen" &rarr; "Neue Bereitstellung".
                        <ul style="list-style-type: disc; margin-left: 20px; margin-top: 5px;">
                            <li style="margin-bottom: 5px;">Klicke auf das Zahnrad-Symbol (‚öôÔ∏è) neben "Typ ausw√§hlen" und w√§hle "Web-App".</li>
                            <li style="margin-bottom: 5px;">Stelle sicher, dass "Ausf√ºhren als:" auf "Ich" und "Zugriff:" auf "Alle" gesetzt ist.</li>
                            <li style="margin-bottom: 5px;">Klicke auf "Bereitstellen".</li>
                            <li style="margin-bottom: 5px;">Es erscheint ein Dialog "Autorisierung erforderlich". Klicke auf "Autorisieren", w√§hle dein Google-Konto, klicke auf "Erweitert" und dann "Zu [Projektname] gehen (nicht sicher)" und "Zulassen".</li>
                            <li style="margin-bottom: 5px;">Kopiere die angezeigte "Web-App-URL".</li>
                        </ul>
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>6. In Render konfigurieren:</strong> Gehe zu deinem Render Dashboard, w√§hle deinen Backend-Service und f√ºge unter "Environment" eine neue Umgebungsvariable hinzu:
                        <ul style="list-style-type: disc; margin-left: 20px; margin-top: 5px;">
                            <li style="margin-bottom: 5px;"><strong>Key:</strong> <code>GOOGLE_SHEETS_WEBHOOK_URL</code></li>
                            <li style="margin-bottom: 5px;"><strong>Value:</strong> Die kopierte Web-App-URL</li>
                        </ul>
                        Speichere die √Ñnderungen. Dein Service wird automatisch neu gestartet.
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>7. Testen:</strong> Generiere eine Nachricht mit der Extension. Die Nachricht sollte automatisch in deinem Google Sheet erscheinen.
                    </li>
                </ol>
                <p style="margin-top: 30px; color: #00d4ff; font-weight: 600;">Methode 2: Google Sheets API (robuster, aber komplexer)</p>
                <p style="margin-bottom: 20px; color: rgba(224, 224, 224, 0.8);">
                    Diese Methode ist robuster, erfordert aber die Einrichtung eines Google Cloud Service Accounts und das Generieren von JSON-Anmeldeinformationen. Diese m√ºssen dann als Umgebungsvariable <code>GOOGLE_SHEETS_CREDENTIALS</code> (als JSON-String) und die <code>GOOGLE_SHEETS_SPREADSHEET_ID</code> in Render hinterlegt werden.
                </p>
            </div>
        </div>

        <!-- Add Situation Modal -->
        <div id="addSituationModal" class="modal">
            <div class="modal-content">
                <h2>Neue Situation erstellen</h2>
                <div class="form-group">
                    <label for="newSituationName">Situationsname</label>
                    <input type="text" id="newSituationName" placeholder="z.B. Bot-Vorwurf">
                </div>
                <div class="form-group">
                    <label for="newSituationResponse">Antwort f√ºr diese Situation</label>
                    <textarea id="newSituationResponse" placeholder="Wie soll die KI in dieser Situation reagieren?"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" onclick="createSituationFromModal()">Erstellen</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddSituationModal()">Abbrechen</button>
                </div>
            </div>
        </div>

        <!-- Add User Modal -->
        <div id="addUserModal" class="modal">
            <div class="modal-content">
                <h2>Neuen Benutzer erstellen</h2>
                <div class="form-group">
                    <label for="newUserEmail">E-Mail</label>
                    <input type="email" id="newUserEmail" placeholder="benutzer@example.com">
                </div>
                <div class="form-group">
                    <label for="newUserPassword">Passwort</label>
                    <input type="password" id="newUserPassword" placeholder="Passwort">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" onclick="createUserFromModal()">Erstellen</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddUserModal()">Abbrechen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentRules = null;
        let trainingData = [];
        let testChatMessages = [];

        // Tab switching
        function showTab(tabName) {
            // Verstecke alle Tab-Contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Entferne active von allen Tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Zeige gew√§hlten Tab-Content
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.style.display = 'block';
            }
            
            // Aktiviere entsprechenden Tab-Button
            const tabMap = {
                'rules': 'REGELN',
                'training': 'TRAINING DATA',
                'test-chat': 'TEST CHAT',
                'statistics': 'STATISTIKEN',
                'users': 'USER MANAGEMENT',
                'settings': 'EINSTELLUNGEN'
            };
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent === tabMap[tabName]) {
                    tab.classList.add('active');
                }
            });

            // Lade Daten f√ºr den gew√§hlten Tab
            if (tabName === 'statistics') {
                loadStatistics();
            } else if (tabName === 'training') {
                loadTrainingData();
            } else if (tabName === 'rules') {
                loadRules();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'test-chat') {
                // Test Chat initialisieren
            }
        }

        // Load rules
        async function loadRules() {
            try {
                console.log('Lade Regeln...');
                const response = await apiCall('/api/v1/rules', 'GET');
                console.log('Regeln geladen:', response);
                if (response) {
                    currentRules = response;
                    // Forbidden Words
                    const forbiddenEl = document.getElementById('forbiddenWords');
                    if (forbiddenEl) {
                        if (response.forbiddenWords && response.forbiddenWords.length > 0) {
                            forbiddenEl.value = Array.isArray(response.forbiddenWords) 
                                ? response.forbiddenWords.join('\n') 
                                : (typeof response.forbiddenWords === 'string' ? response.forbiddenWords : '');
                        } else {
                            forbiddenEl.value = '';
                        }
                    }
                    
                    // Preferred Words
                    const preferredEl = document.getElementById('preferredWords');
                    if (preferredEl) {
                        if (response.preferredWords && response.preferredWords.length > 0) {
                            preferredEl.value = Array.isArray(response.preferredWords)
                                ? response.preferredWords.join('\n')
                                : (typeof response.preferredWords === 'string' ? response.preferredWords : '');
                        } else {
                            preferredEl.value = '';
                        }
                    }
                    
                    // General Rules
                    const generalEl = document.getElementById('generalRules');
                    if (generalEl) {
                        generalEl.value = response.generalRules || '';
                    }
                    
                    displaySituationalResponses();
                } else {
                    console.warn('Keine Regeln erhalten');
                    // Setze leere Werte
                    const forbiddenEl = document.getElementById('forbiddenWords');
                    if (forbiddenEl) forbiddenEl.value = '';
                    const preferredEl = document.getElementById('preferredWords');
                    if (preferredEl) preferredEl.value = '';
                    const generalEl = document.getElementById('generalRules');
                    if (generalEl) generalEl.value = '';
                }
            } catch (error) {
                console.error('Fehler beim Laden der Regeln:', error);
                // Setze leere Werte bei Fehler
                const forbiddenEl = document.getElementById('forbiddenWords');
                if (forbiddenEl) forbiddenEl.value = '';
                const preferredEl = document.getElementById('preferredWords');
                if (preferredEl) preferredEl.value = '';
                const generalEl = document.getElementById('generalRules');
                if (generalEl) generalEl.value = '';
            }
        }

        // Display situational responses
        function displaySituationalResponses() {
            const list = document.getElementById('situationalResponsesList');
            if (!list) return;
            
            if (!currentRules || !currentRules.situationalResponses || Object.keys(currentRules.situationalResponses).length === 0) {
                list.innerHTML = '<p style="color: rgba(224, 224, 224, 0.7); margin-bottom: 20px;">Noch keine Situationen definiert.</p>';
                
                // Zeige auch die hardcodierten Anweisungen aus reply.js
                list.innerHTML += `
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0, 212, 255, 0.3);">
                        <h3 style="color: #00d4ff; margin-bottom: 15px; font-size: 1.2em;">üìã Vordefinierte Anweisungen (aus reply.js):</h3>
                        <div class="rule-item">
                            <h3>üö® Bot-Vorwurf</h3>
                            <p>Reagiere verletzt und abweisend auf diese Unterstellung. Sage klar, dass du KEIN Bot/KI/Fake bist. Frage, warum er das denkt. Sei emotional und menschlich in deiner Reaktion.</p>
                        </div>
                        <div class="rule-item">
                            <h3>üíã Sexuelle Themen</h3>
                            <p>Wenn der Kunde Komplimente macht, erwidere das Kompliment. Stelle dann eine flirty Frage. Sei offen und flirty, aber nicht √ºbertrieben.</p>
                        </div>
                        <div class="rule-item">
                            <h3>üíº Berufsfrage</h3>
                            <p>Falls kein Beruf im Logbuch steht, erfinde einen realistischen Beruf. Nenne den Beruf nat√ºrlich in deiner Antwort. Keine Flugzeugbegleiter, Zugkontrolleur oder √§hnliche Berufe.</p>
                        </div>
                        <div class="rule-item">
                            <h3>üö´ Treffen/Termine</h3>
                            <p>NIEMALS einem Treffen zustimmen oder einen Termin ausmachen! Lenke ab: "Ich m√∂chte dich noch besser kennenlernen, bevor wir uns treffen". Sei freundlich, aber weiche der Frage aus.</p>
                        </div>
                        <div class="rule-item">
                            <h3>üí∏ Geld/Coins</h3>
                            <p>Nicht √ºber Geld/Coins/aufladen/kostenlos sprechen. Keine Hinweise zum Aufladen geben. Freundlich ausweichen und mit einer zum aktuellen Thema passenden Frage direkt im Gespr√§ch bleiben.</p>
                        </div>
                    </div>
                `;
                return;
            }

            let html = Object.keys(currentRules.situationalResponses).map(situation => `
                <div class="rule-item">
                    <h3>${situation}</h3>
                    <p style="white-space: pre-wrap; word-wrap: break-word;">${currentRules.situationalResponses[situation]}</p>
                    <button class="btn btn-secondary" onclick="deleteSituation('${situation}')">L√∂schen</button>
                </div>
            `).join('');
            
            // Zeige auch die hardcodierten Anweisungen
            html += `
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0, 212, 255, 0.3);">
                    <h3 style="color: #00d4ff; margin-bottom: 15px; font-size: 1.2em;">üìã Vordefinierte Anweisungen (aus reply.js):</h3>
                    <div class="rule-item">
                        <h3>üö® Bot-Vorwurf</h3>
                        <p>Reagiere verletzt und abweisend auf diese Unterstellung. Sage klar, dass du KEIN Bot/KI/Fake bist. Frage, warum er das denkt. Sei emotional und menschlich in deiner Reaktion.</p>
                    </div>
                    <div class="rule-item">
                        <h3>üíã Sexuelle Themen</h3>
                        <p>Wenn der Kunde Komplimente macht, erwidere das Kompliment. Stelle dann eine flirty Frage. Sei offen und flirty, aber nicht √ºbertrieben.</p>
                    </div>
                    <div class="rule-item">
                        <h3>üíº Berufsfrage</h3>
                        <p>Falls kein Beruf im Logbuch steht, erfinde einen realistischen Beruf. Nenne den Beruf nat√ºrlich in deiner Antwort. Keine Flugzeugbegleiter, Zugkontrolleur oder √§hnliche Berufe.</p>
                    </div>
                    <div class="rule-item">
                        <h3>üö´ Treffen/Termine</h3>
                        <p>NIEMALS einem Treffen zustimmen oder einen Termin ausmachen! Lenke ab: "Ich m√∂chte dich noch besser kennenlernen, bevor wir uns treffen". Sei freundlich, aber weiche der Frage aus.</p>
                    </div>
                    <div class="rule-item">
                        <h3>üí∏ Geld/Coins</h3>
                        <p>Nicht √ºber Geld/Coins/aufladen/kostenlos sprechen. Keine Hinweise zum Aufladen geben. Freundlich ausweichen und mit einer zum aktuellen Thema passenden Frage direkt im Gespr√§ch bleiben.</p>
                    </div>
                </div>
            `;
            
            list.innerHTML = html;
        }

        // Update rules
        async function updateRules() {
            try {
                const forbiddenWords = document.getElementById('forbiddenWords').value.split('\n').map(w => w.trim()).filter(w => w);
                const preferredWords = document.getElementById('preferredWords').value.split('\n').map(w => w.trim()).filter(w => w);
                const generalRules = document.getElementById('generalRules').value.trim();

                if (!currentRules) {
                    currentRules = {};
                }

                currentRules.forbiddenWords = forbiddenWords;
                currentRules.preferredWords = preferredWords;
                currentRules.generalRules = generalRules;

                const response = await apiCall('/api/v1/rules', 'PUT', currentRules);
                if (response) {
                    alert('Regeln erfolgreich gespeichert!');
                    await loadRules();
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Speichern der Regeln.');
            }
        }

        // Delete situation
        async function deleteSituation(situation) {
            if (!confirm(`M√∂chtest du die Situation "${situation}" wirklich l√∂schen?`)) return;

            try {
                if (currentRules && currentRules.situationalResponses) {
                    delete currentRules.situationalResponses[situation];
                    const response = await apiCall('/api/v1/rules', 'PUT', currentRules);
                    if (response) {
                        await loadRules();
                        await updateSituationSelect();
                    }
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim L√∂schen der Situation.');
            }
        }

        // Load training data
        async function loadTrainingData() {
            try {
                console.log('Lade Training Data...');
                const response = await apiCall('/api/v1/training-data', 'GET');
                console.log('Training Data geladen:', response);
                if (response) {
                    trainingData = response.conversations || [];
                    console.log('Anzahl Gespr√§che:', trainingData.length);
                    displayConversations();
                    updateSituationSelect();
                } else {
                    console.warn('Keine Training Data erhalten');
                    trainingData = [];
                    displayConversations();
                }
            } catch (error) {
                console.error('Fehler beim Laden der Training Data:', error);
                trainingData = [];
                displayConversations();
            }
        }

        // Display conversations
        function displayConversations() {
            const list = document.getElementById('conversationsList');
            const count = document.getElementById('conversationCount');
            
            if (!list) {
                console.error('conversationsList Element nicht gefunden');
                return;
            }
            
            if (!count) {
                console.error('conversationCount Element nicht gefunden');
                return;
            }
            
            if (!trainingData || !Array.isArray(trainingData)) {
                trainingData = [];
            }
            
            count.textContent = trainingData.length;

            if (trainingData.length === 0) {
                list.innerHTML = '<p style="color: rgba(224, 224, 224, 0.7);">Noch keine Gespr√§che gespeichert.</p>';
                return;
            }

            list.innerHTML = trainingData.map((conv, index) => `
                <div class="conversation-item">
                    <h3>Situation: ${conv.situation || 'Allgemein'}</h3>
                    <p><strong>Kunde:</strong> ${conv.customerMessage || ''}</p>
                    <p><strong>Moderator:</strong> ${conv.moderatorResponse || ''}</p>
                    <button class="btn btn-secondary" onclick="deleteConversation(${index})" style="margin-top: 10px;">L√∂schen</button>
                </div>
            `).join('');
        }

        // Filter conversations
        function filterConversations() {
            const searchTerm = document.getElementById('searchConversations').value.toLowerCase();
            const items = document.querySelectorAll('.conversation-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Add conversation
        document.getElementById('addConversationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerMessage = document.getElementById('customerMessage').value.trim();
            const moderatorResponse = document.getElementById('moderatorResponse').value.trim();
            const situation = document.getElementById('situation').value;

            if (!customerMessage || !moderatorResponse) {
                alert('Bitte f√ºlle alle Felder aus.');
                return;
            }

            try {
                const response = await apiCall('/api/v1/training-data', 'POST', {
                    customerMessage,
                    moderatorResponse,
                    situation
                });

                if (response) {
                    document.getElementById('addConversationForm').reset();
                    await loadTrainingData();
                    alert('Gespr√§ch erfolgreich hinzugef√ºgt!');
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Hinzuf√ºgen des Gespr√§chs.');
            }
        });

        // Delete conversation
        async function deleteConversation(index) {
            if (!confirm('M√∂chtest du dieses Gespr√§ch wirklich l√∂schen?')) return;

            try {
                const response = await apiCall(`/api/v1/training-data/${index}`, 'DELETE');
                if (response) {
                    await loadTrainingData();
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim L√∂schen.');
            }
        }

        // Update situation select
        async function updateSituationSelect() {
            try {
                const response = await apiCall('/api/v1/rules', 'GET');
                if (response) {
                    currentRules = response;
                    const select = document.getElementById('situation');
                    const currentValue = select.value;
                    select.innerHTML = '<option value="allgemein">Allgemein</option>';
                    
                    if (response.situationalResponses && typeof response.situationalResponses === 'object') {
                        Object.keys(response.situationalResponses).forEach(situation => {
                            const option = document.createElement('option');
                            option.value = situation;
                            option.textContent = situation;
                            select.appendChild(option);
                        });
                    }
                    select.value = currentValue || 'allgemein';
                }
            } catch (error) {
                console.error('Fehler beim Laden der Situationen:', error);
            }
        }

        // Situation modal
        function showAddSituationModal() {
            document.getElementById('addSituationModal').classList.add('active');
        }

        function closeAddSituationModal() {
            document.getElementById('addSituationModal').classList.remove('active');
            document.getElementById('newSituationName').value = '';
            document.getElementById('newSituationResponse').value = '';
        }

        async function createSituationFromModal() {
            const name = document.getElementById('newSituationName').value.trim();
            const response = document.getElementById('newSituationResponse').value.trim();

            if (!name || !response) {
                alert('Bitte f√ºlle alle Felder aus.');
                return;
            }

            try {
                if (!currentRules) {
                    currentRules = { situationalResponses: {} };
                }
                if (!currentRules.situationalResponses) {
                    currentRules.situationalResponses = {};
                }

                currentRules.situationalResponses[name] = response;

                const updateResponse = await apiCall('/api/v1/rules', 'PUT', currentRules);
                if (updateResponse) {
                    closeAddSituationModal();
                    await updateSituationSelect();
                    await loadRules();
                    alert('Situation erfolgreich erstellt!');
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Erstellen der Situation.');
            }
        }

        // Test Chat
        async function sendTestMessage() {
            const input = document.getElementById('testChatInput');
            const message = input.value.trim();
            if (!message) return;

            testChatMessages.push({ type: 'user', text: message });
            updateTestChat();
            input.value = '';

            try {
                const response = await apiCall('/api/v1/test-chat', 'POST', {
                    message,
                    conversationHistory: testChatMessages.filter(m => m.type !== 'system')
                });

                if (response && response.reply) {
                    testChatMessages.push({ type: 'assistant', text: response.reply });
                    updateTestChat();
                }
            } catch (error) {
                console.error('Fehler:', error);
                testChatMessages.push({ type: 'system', text: 'Fehler beim Senden der Nachricht.' });
                updateTestChat();
            }
        }

        function updateTestChat() {
            const container = document.getElementById('testChatContainer');
            container.innerHTML = testChatMessages.map(msg => `
                <div class="chat-message ${msg.type === 'user' ? 'user' : ''}">
                    <strong>${msg.type === 'user' ? 'Du' : msg.type === 'assistant' ? 'KI' : 'System'}:</strong> ${msg.text}
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        function clearTestChat() {
            testChatMessages = [];
            updateTestChat();
        }

        // Statistics
        async function loadStatistics() {
            try {
                const response = await apiCall('/api/v1/statistics', 'GET');
                if (response) {
                    document.getElementById('statToday').textContent = response.today || 0;
                    document.getElementById('statYesterday').textContent = response.yesterday || 0;
                    document.getElementById('statThisWeek').textContent = response.thisWeek || 0;
                    document.getElementById('statTotal').textContent = response.total || 0;

                    const platformList = document.getElementById('platformList');
                    if (response.platforms && Object.keys(response.platforms).length > 0) {
                        platformList.innerHTML = Object.entries(response.platforms).map(([platform, count]) => `
                            <li>
                                <span>${platform}</span>
                                <span>${count} Nachrichten</span>
                            </li>
                        `).join('');
                    } else {
                        platformList.innerHTML = '<li>Keine Plattformen gefunden</li>';
                    }

                    const recentMessages = document.getElementById('recentMessages');
                    if (response.recentMessages && response.recentMessages.length > 0) {
                        recentMessages.innerHTML = response.recentMessages.slice(0, 10).map(msg => `
                            <div class="message-item">
                                <p><strong>${msg.platform}</strong> - ${new Date(msg.timestamp).toLocaleString('de-DE')}</p>
                                <p style="font-size: 0.9em; color: rgba(224, 224, 224, 0.7);">${msg.customerMessage.substring(0, 100)}${msg.customerMessage.length > 100 ? '...' : ''}</p>
                            </div>
                        `).join('');
                    } else {
                        recentMessages.innerHTML = '<p style="color: rgba(224, 224, 224, 0.7);">Keine Nachrichten gefunden</p>';
                    }
                }
            } catch (error) {
                console.error('Fehler beim Laden der Statistiken:', error);
            }
        }

        // Users
        async function loadUsers() {
            try {
                const response = await apiCall('/api/v1/users', 'GET');
                if (response && response.users) {
                    const list = document.getElementById('usersList');
                    list.innerHTML = response.users.map(user => `
                        <div class="user-item">
                            <h3>${user.email}</h3>
                            <p>Rolle: ${user.role || 'User'}</p>
                            <button class="btn btn-secondary" onclick="deleteUser('${user.id}')">L√∂schen</button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Fehler beim Laden der Benutzer:', error);
            }
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.remove('active');
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserPassword').value = '';
        }

        async function createUserFromModal() {
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();

            if (!email || !password) {
                alert('Bitte f√ºlle alle Felder aus.');
                return;
            }

            try {
                const response = await apiCall('/api/v1/users', 'POST', { email, password });
                if (response) {
                    closeAddUserModal();
                    await loadUsers();
                    alert('Benutzer erfolgreich erstellt!');
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Erstellen des Benutzers.');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('M√∂chtest du diesen Benutzer wirklich l√∂schen?')) return;

            try {
                const response = await apiCall(`/api/v1/users/${userId}`, 'DELETE');
                if (response) {
                    await loadUsers();
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim L√∂schen.');
            }
        }

        // API Call helper
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const token = localStorage.getItem('token');
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                // F√ºge Token nur hinzu, wenn vorhanden
                if (token) {
                    options.headers['Authorization'] = `Bearer ${token}`;
                }

                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                if (!response.ok) {
                    // Bei 401-Fehler, versuche ohne Token (falls SKIP_AUTH aktiv ist)
                    if (response.status === 401 && token) {
                        console.warn('401 Fehler mit Token, versuche ohne Token...');
                        delete options.headers['Authorization'];
                        const retryResponse = await fetch(`${API_BASE}${endpoint}`, options);
                        if (retryResponse.ok) {
                            const contentType = retryResponse.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                return await retryResponse.json();
                            }
                            return await retryResponse.text();
                        }
                    }
                    const errorText = await response.text();
                    console.error(`API Fehler ${response.status}:`, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return await response.json();
                }
                return await response.text();
            } catch (error) {
                console.error('API Call Fehler:', error);
                throw error;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Lade initial nur die aktiven Tabs
            loadRules();
            loadTrainingData();
            updateSituationSelect();
        });
    </script>
</body>
</html>
